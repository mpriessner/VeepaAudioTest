# Veepa SDK Reference

Reference documentation for the Veepa camera SDK integration, based on official documentation.

## Overview

The Veepa camera SDK enables integration with external Wi-Fi cameras. The SDK is primarily Flutter-based, with native iOS components for low-level operations.

**Official Documentation Location**: `/Users/mpriessner/windsurf_repos/VeepaCameraPOC/docs/official_documentation/`

## Device Types

### 4G Devices
- Built-in 4G connectivity
- Require device ID + password binding
- No WiFi configuration needed

### WiFi Devices
- WiFi-enabled cameras
- Require QR code configuration for network setup
- Most common type used in SciSymbioLens

### Low-Power Devices
- Battery-powered
- Reduced feature set (human detection only)
- Limited to 5-second recording segments

### Corded Electric Devices
- Fully-featured wired cameras
- Motion detection support
- Continuous recording capability

## Core Concepts

### Device ID (VUID)

Unique identifier found on camera body label:
- Format: `VP0191279WWIS` (example)
- Used for all API operations
- Encoded in device QR code

### Default Credentials

| Field | Value |
|-------|-------|
| Username | `admin` |
| Password | `888888` |

### Connection States

```
connecting → logging → connected (success)
         → timeout (failure)
         → disconnect (failure)
         → password (auth failure)
         → offline (device unreachable)
         → illegal (invalid credentials)
```

## SDK Components

### Native iOS (`VeepaSDK/`)

| File | Purpose |
|------|---------|
| `libVSTC.a` | Static library (core SDK) |
| `VsdkPlugin.h/m` | Flutter plugin interface |
| `AppP2PApiPlugin.h` | P2P API interface |
| `AppPlayerPlugin.h` | Video player interface |

### Flutter SDK (`app_dart.dart`)

```dart
// Core device object
class CameraDevice {
  final String id;
  final String name;
  final String username;
  final String password;
  final String? model;

  // Connection
  Future<CameraConnectState> connect();
  Future<void> disconnect();

  // Streaming
  Future<void> startStream();
  Future<void> stopStream();

  // Commands
  Future<void> writeCgi(String command);
  Future<String> waitCommandResult(int cmd);
}
```

## Connection Flow

### 1. Device Discovery

Devices are discovered on the local network using mDNS/Bonjour:

```dart
// In veepa_discovery_service.dart
class VeepaDiscoveryService {
  Future<void> startDiscovery() async {
    final scanner = VeepaDeviceScanner();
    scanner.onDeviceFound = (device) {
      // Device discovered on LAN
    };
    await scanner.startScan(timeout: Duration(seconds: 10));
  }
}
```

### 2. Device Connection

```dart
// In veepa_connection_manager.dart
Future<void> connect(String deviceId, String username, String password) async {
  _currentDevice = CameraDevice(
    id: deviceId,
    name: deviceId,
    username: username,
    password: password,
  );

  final result = await _currentDevice!.connect();

  if (result == CameraConnectState.connected) {
    // Success
  } else {
    throw VeepaConnectionException('Connection failed: $result');
  }
}
```

### 3. Video Streaming

```dart
// Start streaming
await _currentDevice.startStream();

// Handle frames
AppPlayerController.onFrame = (frameData) {
  // Process frame data (H.264 encoded)
};

// Stop streaming
await _currentDevice.stopStream();
```

## QR Code Provisioning

### Device QR Code Content

The QR code on the camera encodes:

```json
{
  "ACT": "Add",
  "ID": "ZYLX0092354DSTM",    // Device VUID
  "WiFi": "15",               // Device type code
  "S": "0"                    // Static/Dynamic indicator
}
```

### Network Config QR Code

Generated by the app to configure the camera's WiFi:

```json
{
  "BS": "e0d462e663b0",      // Router MAC (optional)
  "P": "1111111111",         // Router password
  "U": "12965091",           // Unique user ID
  "RS": "vstarcam123",       // Router SSID
  "A": "1"                   // Region code
}
```

### Provisioning Flow

```
1. User scans camera QR code
   → Parse device info (VUID, type)

2. App generates WiFi config QR
   → Encode current WiFi credentials

3. User shows QR to camera
   → Camera reads and connects to WiFi

4. Camera appears on LAN
   → App discovers via mDNS

5. App connects with P2P credentials
   → Username: admin, Password: 888888

6. Credentials cached for future use
```

## CGI Commands

### Authentication Methods

1. **HTTP Basic Auth**
```
GET /get_status.cgi HTTP/1.1
Authorization: Basic admin:888888
```

2. **Parameter-based**
```
POST /get_status.cgi?user=admin&password=888888
```

### Common Commands

| Command | Purpose |
|---------|---------|
| `get_status.cgi` | Get device status |
| `get_params.cgi` | Get device parameters |
| `set_alias.cgi` | Set device name |
| `snapshot.cgi` | Capture still image |
| `videostream.cgi` | Start video stream |
| `camera_control.cgi` | PTZ control |
| `reboot.cgi` | Restart device |

### Example: Get Status

```swift
// Via Swift bridge
let response = await veepaBridge.sendCommand("get_status.cgi")
```

Response format:
```javascript
var alias="IPCAM";
var sys_ver="Apr 28 2011 00:18:03";
var id="00000000031729";
```

## Video Streaming Protocols

### HTTP Streaming
```
GET /videostream.cgi
```
Push protocol, continuous connection.

### Live Stream
```
GET /livestream.cgi
```
For real-time viewing.

### RTSP
```
rtsp://device_ip:554/stream
```
Standard RTSP protocol (if supported).

## Motion Detection

### Corded Electric Devices

```
// Enable motion detection
trans_cmd_string.cgi?cmd=2106&command=9&motionDetectSwitch=1

// Set sensitivity (1=High, 5=Medium, 9=Low)
trans_cmd_string.cgi?cmd=2106&command=9&motionDetectSensitivity=5
```

### Low-Power Devices

```
// Enable human detection
trans_cmd_string.cgi?cmd=2106&command=9&pirPushSwitch=1

// Set frequency (0=Off, 1=High, 2=Medium, 3=Low)
trans_cmd_string.cgi?cmd=2106&command=9&pirFrequency=2
```

## Error Handling

### Connection Errors

| State | Meaning | Recovery |
|-------|---------|----------|
| `timeout` | Connection attempt exceeded time | Retry with backoff |
| `disconnect` | Connection lost | Auto-reconnect |
| `password` | Authentication failed | Check credentials |
| `maxUser` | Too many connections | Wait, then retry |
| `offline` | Device unreachable | Check network |
| `illegal` | Invalid credentials | Re-provision |

### Retry Strategy

```swift
// Exponential backoff
let delays = [0, 30, 120, 600]  // seconds
var attempt = 0

func reconnect() async {
    guard attempt < delays.count else {
        // Max attempts reached
        return
    }

    try await Task.sleep(nanoseconds: UInt64(delays[attempt]) * 1_000_000_000)
    attempt += 1

    do {
        try await connect()
        attempt = 0  // Reset on success
    } catch {
        await reconnect()  // Try again
    }
}
```

## Implementation in SciSymbioLens

### Swift ↔ Flutter Bridge

```
Swift Layer                    Flutter Layer                  Native SDK
─────────────────────────────────────────────────────────────────────────
FlutterEngineManager           main.dart                      libVSTC.a
        │                           │                              │
        │  Method Channel           │                              │
        ├──────────────────────────►│                              │
        │  "connectToCamera"        │                              │
        │                           │  Plugin Call                 │
        │                           ├─────────────────────────────►│
        │                           │                              │
        │  Event Channel            │                              │
        │◄──────────────────────────┤  Frame Data                  │
        │  "veepa_frame_events"     │◄─────────────────────────────┤
```

### Frame Flow

```
Veepa Camera
    │
    │ (H.264 video stream)
    ▼
libVSTC.a (decode)
    │
    │ (Raw frame data)
    ▼
VsdkPlugin (native)
    │
    │ (Platform channel)
    ▼
veepa_frame_handler.dart
    │
    │ (Event channel)
    ▼
VeepaFrameBridge (Swift)
    │
    │ (Buffer latest frame)
    ▼
VeepaCameraSource
    │
    │ (getLatestFrame())
    ▼
StreamingService → Gemini
```

## Performance Characteristics

| Metric | Typical Value |
|--------|---------------|
| Connection time | 2-5 seconds |
| Stream latency | 100-200ms |
| Max frame rate | 30 fps |
| Max resolution | 1080p |
| Reconnect timeout | ~3 minutes |

## Known Limitations

### Current Issues

1. **Auto-reconnect timeout**: Connection drops after ~3 minutes of idle
   - Workaround: Implement keepalive/heartbeat
   - See: `docs/debugging/AUTO_RECONNECT_SOLUTION_PLAN.md`

2. **Frame rate variability**: Actual FPS may be lower than requested
   - Depends on network conditions
   - SDK does not guarantee frame rate

3. **No recording support**: Recording must be done at app level
   - Frames captured and saved locally
   - No direct cloud recording

### Veepa SDK Limitations

- WiFi setup requires physical access to camera
- Single connection per device
- Limited PTZ support on some models
- No audio streaming on some models

## Cloud Storage Integration

### Available Services

1. **D004**: Motion Detection Cloud Storage
   - For corded devices
   - Continuous recording
   - Video summaries, daily clips

2. **D015**: Low-Power Cloud Storage
   - For battery devices
   - 5-second segments
   - Event-triggered

### API Endpoints

Base URL: `https://open.eye4.cn`

| Endpoint | Purpose |
|----------|---------|
| `POST /product/list` | Get available plans |
| `POST /service/open` | Activate service |
| `POST /service/D004/info` | Query status |
| `POST /service/D004/license` | Get playback auth |

## Security Considerations

### Credential Storage

- Store P2P credentials in Keychain
- Never log passwords in plaintext
- Use HTTPS for all cloud API calls

### Network Security

- Camera communicates on local LAN
- P2P connection is encrypted
- Cloud uploads use signed URLs

### Privacy

- Video frames processed locally
- Only sent to Gemini when streaming enabled
- No persistent storage on Veepa servers (for P2P mode)

## Troubleshooting

### Camera Not Discovered

1. Check both devices on same WiFi network
2. Verify local network permission in iOS settings
3. Try restarting camera
4. Check router allows mDNS/Bonjour

### Connection Fails

1. Verify credentials (default: admin/888888)
2. Check camera is online (LED status)
3. Try re-provisioning
4. Check for firmware updates

### Stream Drops

1. Check WiFi signal strength
2. Reduce frame rate
3. Check for network congestion
4. Implement auto-reconnect

### No Video Frames

1. Verify streaming started successfully
2. Check frame handler is registered
3. Verify camera supports video
4. Check device model compatibility

## References

- [Flutter SDK Parameters](../../VeepaCameraPOC/docs/official_documentation/flutter_sdk_parameter_usage_instructions.md)
- [CGI Command Manual](../../VeepaCameraPOC/docs/official_documentation/CGI_COMMAND_MANUAL.md)
- [Cloud Video Interface](../../VeepaCameraPOC/docs/official_documentation/Cloud_Video_Interface_Document_v1.0.md)
- [Open Platform API](../../VeepaCameraPOC/docs/official_documentation/Open_Platform_API_Document_v1.0-English.md)
- [Device Adding Process](../../VeepaCameraPOC/docs/official_documentation/veepai_device_adding_and_usage_process.md)

---

*Last updated: January 2026*
